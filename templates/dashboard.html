<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DUNL Smart Logistics Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid #334155; }
        #map, #network { width: 100%; height: 100%; }
        /* Dark map tiles */
        .leaflet-layer { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="h-14 border-b border-slate-700 bg-slate-900 flex items-center justify-between px-4 z-50">
        <div class="flex items-center gap-2">
            <div class="bg-indigo-500 w-8 h-8 rounded flex items-center justify-center font-bold text-white">D</div>
            <h1 class="font-bold tracking-wide">DUNL <span class="text-indigo-400">Smart Link</span> Explorer</h1>
        </div>
        <div class="text-xs text-slate-400 flex gap-4">
            <span class="flex items-center"><div class="w-2 h-2 rounded-full bg-blue-500 mr-2"></div>Benchmark</span>
            <span class="flex items-center"><div class="w-2 h-2 rounded-full bg-slate-500 mr-2"></div>Port</span>
            <span class="flex items-center"><div class="w-8 h-[2px] bg-yellow-500 border-dashed border-t mr-2"></div>Inferred Link</span>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex-1 grid grid-cols-2 gap-4 p-4">
        
        <!-- Left: Map -->
        <div class="glass rounded-xl flex flex-col relative overflow-hidden">
            <div class="absolute top-4 left-4 z-[999] bg-slate-900/90 px-3 py-1 rounded text-xs border border-slate-600">
                <i class="fa-solid fa-earth-americas text-indigo-400 mr-2"></i>Global Logistics
            </div>
            <div id="map"></div>
        </div>

        <!-- Right: Graph & Details -->
        <div class="flex flex-col gap-4">
            <!-- Knowledge Graph -->
            <div class="glass rounded-xl flex-1 relative overflow-hidden">
                <div class="absolute top-4 left-4 z-10 bg-slate-900/90 px-3 py-1 rounded text-xs border border-slate-600">
                    <i class="fa-solid fa-diagram-project text-purple-400 mr-2"></i>Inferred Connections (Entity Resolution)
                </div>
                <div id="network"></div>
            </div>

            <!-- Details Panel -->
            <div class="glass rounded-xl h-48 flex flex-col">
                <div class="p-2 border-b border-slate-700 bg-slate-800/50 flex justify-between items-center">
                    <h3 class="text-xs font-bold uppercase tracking-wider text-slate-300">Selected Entity / Link Analysis</h3>
                    <span class="text-[10px] text-slate-500">DUNL.org</span>
                </div>
                <div id="details" class="p-4 text-sm text-slate-400 overflow-y-auto">
                    <p class="text-center opacity-50 mt-4">Select a node or link to see why they are connected.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Injection -->
    <script>
        const RAW_DATA = {{ payload | tojson }};
    </script>

    <script>
        let map, network;

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            initNetwork();
        });

        function initMap() {
            map = L.map('map', {zoomControl: false, attributionControl: false}).setView([20, 0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {subdomains: 'abcd', maxZoom: 19}).addTo(map);

            // Plot Ports
            RAW_DATA.ports.forEach(p => {
                if(p.lat) {
                    const m = L.circleMarker([p.lat, p.lng], {
                        color: '#64748b', fillColor: '#1e293b', fillOpacity: 1, radius: 6
                    }).addTo(map);
                    m.bindPopup(`<b>${p.name}</b><br>ID: ${p.id}`);
                }
            });
        }

        function initNetwork() {
            const nodes = [];
            const edges = [];
            const exist = new Set();

            // 1. Add Ports (Blue Anchors)
            RAW_DATA.ports.forEach(p => {
                if(!exist.has(p.id)) {
                    nodes.push({id: p.id, label: p.clean_name, group: 'port', shape: 'dot', color: '#64748b'});
                    exist.add(p.id);
                }
            });

            // 2. Add Benchmarks (Blue Tags)
            RAW_DATA.benchmarks.forEach(b => {
                nodes.push({id: b.id, label: b.symbol, group: 'benchmark', shape: 'box', color: '#3b82f6'});
                // Link to commodity parent
                if(!exist.has(b.commodity)) {
                    nodes.push({id: b.commodity, label: b.commodity, group: 'commodity', shape: 'diamond', color: '#f97316'});
                    exist.add(b.commodity);
                }
                edges.push({from: b.commodity, to: b.id, color: '#334155'});
            });

            // 3. Add THE SMART LINKS (Yellow Dashed)
            RAW_DATA.links.forEach(l => {
                edges.push({
                    from: l.source, 
                    to: l.target, 
                    dashes: true, 
                    color: '#eab308', 
                    width: 2,
                    title: `AI Match: ${l.info.reason} (${Math.round(l.info.weight)}% Confidence)` 
                });
            });

            const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
            
            network = new vis.Network(document.getElementById('network'), data, {
                nodes: { font: { color: '#fff' }, borderWidth: 0 },
                edges: { smooth: false },
                physics: { stabilization: false, barnesHut: { gravitationalConstant: -8000 } },
                interaction: { hover: true }
            });

            network.on("click", params => {
                const el = document.getElementById('details');
                
                // If Edge Clicked
                if(params.edges.length > 0 && params.nodes.length === 0) {
                    const edgeId = params.edges[0];
                    const edge = data.edges.get(edgeId);
                    if(edge.title) {
                        el.innerHTML = `
                            <div class="bg-yellow-900/30 border border-yellow-600/50 p-3 rounded">
                                <h4 class="font-bold text-yellow-500 mb-1"><i class="fa-solid fa-bolt"></i> Inferred Connection</h4>
                                <p class="text-white">${edge.title}</p>
                                <p class="text-xs mt-2">The system detected that the Benchmark description mentions the Port name.</p>
                            </div>
                        `;
                    }
                    return;
                }

                // If Node Clicked
                if (params.nodes.length > 0) {
                    const id = params.nodes[0];
                    const port = RAW_DATA.ports.find(p => p.id === id);
                    const bench = RAW_DATA.benchmarks.find(b => b.id === id);

                    if(port) {
                        el.innerHTML = `<h4 class="text-lg text-white font-bold">${port.name}</h4><p>Region: ${port.region}</p><p class="text-xs font-mono mt-2">${port.dunl_uri}</p>`;
                        if(port.lat) map.setView([port.lat, port.lng], 6);
                    } else if (bench) {
                        el.innerHTML = `
                            <h4 class="text-lg text-blue-400 font-bold">${bench.symbol}</h4>
                            <div class="bg-slate-800 p-2 rounded mt-2 mb-2 italic">"${bench.desc}"</div>
                            <p>Commodity: ${bench.commodity}</p>
                            ${bench.linked_port_id ? `<p class="text-green-400 text-xs mt-2"><i class="fa-solid fa-link"></i> Linked to ${bench.linked_port_id}</p>` : ''}
                        `;
                    }
                }
            });
        }
    </script>
</body>
</html>
